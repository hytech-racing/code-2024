
<!-- import jquery library -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

<!-- import paho MQTT library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
<html>
<body>
<head>
    <meta charset="utf-8">
    <title>Data Stream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="../dist/uPlot.min.css">
</head>

<script src="../dist/uPlot.iife.js"></script>

<script>
    //create MQTT clients
    let client1 = new Paho.MQTT.Client('localhost', 8080, "/", "iawgewagwd");
    client1.connect();
    let client2 = new Paho.MQTT.Client('localhost', 8080, "/", "iawgwd");
    client2.connect({ onSuccess: myClientConnected });
    var uplot;


    // This is the function which handles subscribing to topics after a connection is made
    function myClientConnected() {
        console.log("Connected");
        //set topics to subscribe to
        client1.subscribe("MOTOR_CONTROLLER/mc_rl/torque_current");
        client2.subscribe("MOTOR_CONTROLLER/mc_rl/magnetizing_current");
    }

    let data = [
        [],    // x-values (timestamps)
        [],    // y-values (series 1)
        []     // y-values (series 2)
    ];
    let time = 0
    let graphWidth = 750

    // This is the function which handles received messages
    function myMessageArrived(message, series) {

        // Get the payload
        var messageBody = message.payloadString;
        if (messageBody != null) {

        data[0].push(time);
        time++; //im just incrementing the time series by 1 cuz idk if timestamps are included with the MQTT messages
        for (let i = 1; i < data.length; i++){
            if (i === series){
                data[i].push(parseInt(messageBody));
            }
            else{
                data[i].push(data[i][data[i].length-1]); //if this series isn't being updated, just add the last recorded data for that series
            }
        }

        //removes data if there are more than groupWidth data points
        if (data[0].length > graphWidth){
            for (let i = 1; i < data.length; i++){
                data[i].splice(0, 1);
            }
        }
        }
        uplot.setData(data);
    }

    //helper methods
    function handleClient1(message){
        myMessageArrived(message, 1);
    }
    function handleClient2(message){
        myMessageArrived(message, 2);
    }
    //calls handleClient when MQTT message arrives
    client1.onMessageArrived = handleClient1;
    client2.onMessageArrived = handleClient2;


    //uPlot stuff
    function makeChart(data) {

        const opts = {
            title: "Graph",
            width: 1000,
            height: 400,
            scales: {
                'x': {
                    //auto: true,
                    range: (min, max) => [data[0][0], data[0][0]+graphWidth],
                },
                'y': {
                    auto: true,
                    //range: (min, max) => [-50, 50],
                }
            },
            series: [
                {},
                {
                    show: true,
                    spanGaps: true,
                    // in-legend display
                    label: "Torque Current",
                    //value: data[1][data.length],
                    stroke: "red",
                    width: 1,

                },
                {
                    show: true,
                    spanGaps: true,
                    // in-legend display
                    label: "Magnetizing Current",
                    //value: data[2][data.length],
                    stroke: "orange",
                    width: 1,

                },

            ],



        }
         uplot = new uPlot(opts, data, document.body);
    }
    makeChart(data);

</script>
</body>
</html>